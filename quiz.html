<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‘¡è„é…’æ³•å®šç”¢å€æ¨æ¸¬éŠæˆ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <!-- è¿”å›é¡Œåº«é æŒ‰éˆ• -->
  <div class="max-w-xl mx-auto mt-6 flex justify-end">
    <button id="btn-back"
            class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">
      é‡æ–°é¸æ“‡é¡Œåº«
    </button>
  </div>

  <!-- æ¸¬é©—å€ -->
  <div id="quiz" class="max-w-xl mx-auto mt-4 p-6 bg-white rounded shadow">
    <div id="progress" class="text-sm text-gray-500 mb-2"></div>
    <div id="question-box" class="mb-4"></div>
    <div id="options-box" class="mb-4"></div>
    <div id="feedback" class="text-lg"></div>
  </div>

  <!-- éŸ³æ•ˆ -->
  <audio id="aud-correct" src="sounds/correct.mp3" preload="auto"></audio>
  <audio id="aud-wrong"   src="sounds/wrong.mp3"   preload="auto"></audio>
  <audio id="aud-click"   src="sounds/click.mp3"   preload="auto"></audio>
<script>
const API_KEY = "AIzaSyCn4cdaBpY2Fz4SXUMtpMhAN84YvOQACcQ";

const SHEET_INDEX = {
  italy: { id: "1WLrMMYTPRjIxiWueFA1J3rfKzC34xbqver5tqCzP94s" },
  france: { id: "1-8sav2Dl1pi4EfnqNQhpMR0I-TjZhbaIUE6mrC1QbpU" },
  spain: { id: "1EeU1B3AF64S12XOIj9fLi-86_aMNcbmuEdKSBhsCpC4" },
  germany: { id: "1M0yjlT-bXXFhrV-snoGEPw6WhyMSwSEf4O6f7K_zo9o" },
  usa: { id: "1ZsGBl0jHPhQu9nV3k5rJhJ4ZXkkrwSvA6qhY0RaTRxE" },
  hungary: { id: "1Rcf_mH4p1F05MhitSEkcjMaIU2mKmiXi77ifbOjfC14" },
  new_zealand: { id: "1O6TqxxB0YSitH9ySe3pncEx_Zl_kVtcJd2zslBDKw5Y" },
  austria: { id: "1qaxLc9-GMyHgPJCajU0Cs0-vrI4nRFsqn1Y3nvj_-m8" },
  portugal: { id: "18GCPNoDPXu9EcfPd0EmnpEJb0DsP7vQaoAdbGo9cMs4" }
};

let allQuestions = [];
let currentQuestionIndex = 0;
let score = 0;
let difficulty = "easy";
let startTime = 0;

async function loadQuizData() {
  const selected = JSON.parse(localStorage.getItem("selectedRegions") || "[]");
  difficulty = localStorage.getItem("difficulty") || "easy";

  const fetches = selected.map(async key => {
    const [countryKey, sheetName] = key.split("__");
    const sheetId = SHEET_INDEX[countryKey].id;
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    const rows = data.values;
    const headers = rows[0];
    return rows.slice(1).map(row => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = row[i] || "");
      return obj;
    });
  });

  const results = await Promise.all(fetches);
  allQuestions = results.flat();
  shuffle(allQuestions);
  startQuiz();
}

function startQuiz() {
  currentQuestionIndex = 0;
  score = 0;
  startTime = Date.now();
  renderQuestion();
}

function renderQuestion() {
  const q = allQuestions[currentQuestionIndex];
  const container = document.getElementById("question-box");
  const optionsContainer = document.getElementById("options-box");

  let questionText = "";

  let questionText = "";
if (difficulty === "easy") {
  questionText = `
    <div class="mb-2">é€™æ˜¯æ¬¾ä¾†è‡ª<b>${q.Country}</b> çš„ <b>${q.Classification}</b></div>
    <div class="mb-2">é…’çš„é¡å‹æ˜¯ï¼š<b>${q.Wine_type}</b>, <b>${q.Sub_type}</b></div>
    <div class="mb-2">ä¸»è¦è‘¡è„å“ç¨®ç‚ºï¼š<b>${q.Grape_1}</b></div>
    <div class="mb-2">æ˜¯å¦æ··é‡€ï¼š<b>${q.Is_blend}</b></div>
    <div class="mb-2">æ¬¡è¦è‘¡è„å“ç¨®ç‚ºï¼š<b>${q.Grape_2}</b></div>
    <div class="mb-2">æ¬¡ç”¢å€ï¼š<b>${q.Sub_region}</b></div>
    <div class="my-4 font-semibold">è«‹å•é€™æ˜¯å“ªå€‹æ³•å®šç”¢å€ï¼Ÿ</div>
  `;
}
  } else {
    questionText = `
      é€™æ˜¯æ¬¾ã€${q.Wine_type}ã€‘ï¼Œ<br/>
      ä¸»è¦ä½¿ç”¨ã€${q.Grape_1}ã€‘é‡€è£½ï¼Œ<br/>
      è«‹å•æ³•å®šç”¢å€æ˜¯å“ªå€‹ï¼Ÿ
    `;
  }

  container.innerHTML = `
    <div class="mb-2 text-sm text-gray-600">ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${allQuestions.length} é¡Œ</div>
    <div class="text-lg font-medium mb-4">${questionText}</div>
  `;

  // é¡Œç›®é¸é …ï¼šéš¨æ©ŸæŒ‘é¸ 4 å€‹ç”¢å€ï¼ˆå«æ­£ç¢ºç­”æ¡ˆï¼‰
  const correct = q.Region;
  const options = [correct];

  while (options.length < 4) {
    const rand = allQuestions[Math.floor(Math.random() * allQuestions.length)].Region;
    if (!options.includes(rand)) options.push(rand);
  }

  shuffle(options);

  optionsContainer.innerHTML = "";
  options.forEach(option => {
    const btn = document.createElement("button");
    btn.textContent = option;
    btn.className = "block w-full text-left px-4 py-2 mb-2 bg-white border rounded hover:bg-blue-100";
    btn.onclick = () => checkAnswer(option, correct);
    optionsContainer.appendChild(btn);
  });
}

function checkAnswer(selected, correct) {
  const feedback = document.getElementById("feedback");
  if (selected === correct) {
    score++;
    feedback.textContent = "ç­”å°äº†ï¼";
    feedback.className = "text-green-600 mb-4";
    playSound("correct");
  } else {
    feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`;
    feedback.className = "text-red-600 mb-4";
    playSound("wrong");
  }

  // ä¸‹ä¸€é¡Œ
  currentQuestionIndex++;
  if (currentQuestionIndex < allQuestions.length) {
    setTimeout(() => {
      feedback.textContent = "";
      renderQuestion();
    }, 1000);
  } else {
    setTimeout(showResult, 1000);
  }
}

function showResult() {
  const quizDiv = document.getElementById("quiz");
  const totalTime = Math.round((Date.now() - startTime) / 1000); // ç§’
  const totalQ = allQuestions.length;

  quizDiv.innerHTML = `
    <div class="text-xl font-bold mb-4">ğŸ‰ æ¸¬é©—å®Œæˆï¼</div>
    <div class="mb-2">å¾—åˆ†ï¼š${score} / ${totalQ}</div>
    <div class="mb-4">è€—æ™‚ï¼š${totalTime} ç§’ã€€ï½œã€€é›£åº¦ï¼š${difficulty}</div>
    <input id="player-name" type="text" placeholder="è¼¸å…¥æš±ç¨±å„²å­˜æˆç¸¾"
           class="border px-3 py-1 rounded w-full mb-4" />
    <button id="save-btn" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mb-6">å„²å­˜åˆ°æ’è¡Œæ¦œ</button>
    <h3 class="font-semibold mb-2">ğŸ† æ’è¡Œæ¦œï¼ˆå‰ 10 åï¼‰</h3>
    <ol id="board" class="list-decimal list-inside mb-6"></ol>
    <button onclick="toSelectPage()" class="w-full py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
      é‡æ–°é¸æ“‡é¡Œåº«
    </button>
  `;

  document.getElementById("save-btn").onclick = () =>
    saveLeaderboard(totalQ, totalTime);

  renderBoard();
}

function saveLeaderboard(totalQ, totalTime) {
  const name = document.getElementById("player-name").value.trim() || "ç©å®¶";
  const record = {
    name,
    score,
    totalQ,
    time: totalTime,
    difficulty,
    date: new Date().toLocaleString()
  };

  const board = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  board.push(record);
  board.sort((a, b) => b.score - a.score || a.time - b.time);
  localStorage.setItem("leaderboard", JSON.stringify(board.slice(0, 10)));
  renderBoard();
  document.getElementById("player-name").value = "";
}

function renderBoard() {
  const list = document.getElementById("board");
  if (!list) return;
  const board = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  list.innerHTML = board
    .map(
      (r, i) =>
        `<li>${r.name} - ${r.score}/${r.totalQ} åˆ† - ${r.time}s - ${r.difficulty.toUpperCase()} - ${r.date}</li>`
    )
    .join("");
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function playSound(type) {
  const aud = document.getElementById(`aud-${type}`);
  aud && aud.play();
}

function toSelectPage() {
  location.href = "select.html";
}

document.getElementById("btn-back").onclick = toSelectPage;
window.onload = loadQuizData;
</script>
</body>
</html>
