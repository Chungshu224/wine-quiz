<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>葡萄酒法定產區推測遊戲</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    </head>
<body class="bg-gray-100">
    <div id="quiz" class="max-w-xl mx-auto mt-4 p-6 bg-white rounded shadow">
        <div id="progress" class="text-sm text-gray-500 mb-2"></div>
        <div id="question-box" class="mb-4"></div>
        <div id="options-box" class="mb-4"></div>
        <div id="feedback" class="text-lg"></div>
    </div>

    <div class="max-w-xl mx-auto mt-6 flex justify-end">
        <button id="btn-back" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">
            重新選擇題庫
        </button>
    </div>

    <audio id="aud-correct" src="sounds/correct.mp3" preload="auto"></audio>
    <audio id="aud-wrong" src="sounds/wrong.mp3" preload="auto"></audio>
    <audio id="aud-click" src="sounds/click.mp3" preload="auto"></audio>

    <script>
       const API_KEY = "AIzaSyCn4cdaBpY2Fz4SXUMtpMhAN84YvOQACcQ"; //

        // 定義不同國家試算表的 ID
        const SHEET_INDEX = {
            italy: { id: "1WLrMMYTPRjIxiWueFA1J3rfKzC34xbqver5tqCzP94s" },
            france: { id: "1-8sav2Dl1pi4EfnqNQhpMR0I-TjZhbaIUE6mrC1QbpU" },
            spain: { id: "1EeU1B3AF64S12XOIj9fLi-86_aMNcbmuEdKSBhsCpC4" },
            germany: { id: "1M0yjlT-bXXFhrV-snoGEPw6WhyMSwSEf4O6f7K_zo9o" },
            usa: { id: "1ZsGBl0jHPhQu9nV3k5rJhJ4ZXkkrwSvA6qhY0RaTRxE" },
            hungary: { id: "1Rcf_mH4p1F05MhitSEkcjMaIU2mKmiXi77ifbOjfC14" },
            new_zealand: { id: "1O6TqxxB0YSitH9ySe3pncEx_Zl_kVtcJd2zslBDKw5Y" },
            austria: { id: "1qaxLc9-GMyHgPJCajU0Cs0-vrI4nRFsqn1Y3nvj_-m8" },
            portugal: { id: "18GCPNoDPXu9EcfPd0EmnpEJb0DsP7vQaoAdbGo9cMs4" },
            chile: { id: "1Dv2jeGsefsuCCyuu8uvMKkHd9NgNa7tV0Woo9FrBNEY" },
            south_africa: { id: "13K5yOvCJYZH6oiITdu5lyKH6a5az7octyuT3m7MzYEM" },
            argentina: { id: "1qE_4coepB5_vevCF4KLDq7MMnrLtgU5foTN8e4nmLY" }
        };

        // 全局變數，用於儲存所有題目、當前題目索引、分數、難度及開始時間
        let allQuestions = []; // 從 Google Sheets 載入的所有題目
        let currentQuizQuestions = []; // 當前測驗回合要使用的題目（固定10題）
        let allAppellations = []; // 所有載入的 Appellation，用於生成選項
        let currentQuestionIndex = 0;
        let score = 0;
        let difficulty = "easy";
        let startTime = 0;

        // 遊戲設定：每回合的題目數量
        const QUIZ_LENGTH = 10;

        // 取得主要測驗相關的 DOM 元素引用
        const quizContainer = document.getElementById("quiz");
        let questionBox = document.getElementById("question-box");
        let optionsBox = document.getElementById("options-box");
        let feedback = document.getElementById("feedback");
        let progressIndicator = document.getElementById("progress");

        /**
         * 異步函數：載入測驗題目資料
         * 從 localStorage 獲取用戶選擇的區域和難度，
         * 然後使用 Google Sheets API 獲取資料。
         */
        async function loadQuizData() {
            quizContainer.innerHTML = '<p class="text-center text-gray-500">載入題目中...</p>';

            const selected = JSON.parse(localStorage.getItem("selectedRegions") || "[]");
            difficulty = localStorage.getItem("difficulty") || "easy";

            if (selected.length === 0) {
                quizContainer.innerHTML = '<p class="text-center text-red-500">請先在題庫選擇頁面選擇要練習的產區。</p>';
                return;
            }

            try {
                const fetches = selected.map(async key => {
                    const [countryKey, sheetName] = key.split("__");
                    const sheetId = SHEET_INDEX[countryKey]?.id;
                    if (!sheetId) {
                        console.warn(`SHEET_INDEX 中未找到 ${countryKey} 的 ID。`);
                        return [];
                    }
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/<span class="math-inline">\{sheetId\}/values/</span>{sheetName}?key=${API_KEY}`;
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP 錯誤！狀態碼：<span class="math-inline">\{res\.status\}，網址：</span>{url}`);
                    }
                    const data = await res.json();
                    const rows = data.values;
                    if (!rows || rows.length < 2) {
                        console.warn(`未找到 ${key} 的資料或只有標題。`);
                        return [];
                    }
                    const headers = rows[0];
                    return rows.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((h, i) => obj[h] = row[i] || ""); // <-- IMPORTANT: 使用 || "" 處理 undefined/null 值
                        return obj;
                    });
                });

                const results = await Promise.all(fetches);
                allQuestions = results.flat().filter(q => q.Appellation);

                allAppellations = [...new Set(allQuestions.map(q => q.Appellation))];

                if (allQuestions.length === 0) {
                    quizContainer.innerHTML = '<p class="text-center text-red-500">未能載入任何題目，請檢查所選題庫是否有資料或 Appellation 欄位。</p>';
                    return;
                }

                startQuiz();

            } catch (error) {
                console.error("載入測驗資料時出錯：", error);
                quizContainer.innerHTML = `<p class="text-center text-red-500">載入題目失敗：${error.message}，請檢查網路連線或 API 金鑰是否正確。</p>`;
            }
        }

        /**
         * 開始測驗
         */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            startTime = Date.now();

            currentQuizQuestions = [...allQuestions];
            shuffle(currentQuizQuestions);
            currentQuizQuestions = currentQuizQuestions.slice(0, QUIZ_LENGTH);

            if (currentQuizQuestions.length === 0) {
                quizContainer.innerHTML = '<p class="text-center text-red-500">沒有足夠的題目可以開始測驗，請嘗試選擇更多題庫。</p>';
                return;
            }

            quizContainer.innerHTML = `
                <div id="progress" class="text-sm text-gray-500 mb-2"></div>
                <div id="question-box" class="mb-4"></div>
                <div id="options-box" class="mb-4"></div>
                <div id="feedback" class="text-lg"></div>
            `;
            questionBox = document.getElementById("question-box");
            optionsBox = document.getElementById("options-box");
            feedback = document.getElementById("feedback");
            progressIndicator = document.getElementById("progress");

            renderQuestion();
        }

        /**
         * 渲染題目到頁面
         */
        function renderQuestion() {
            const q = currentQuizQuestions[currentQuestionIndex];
            if (!q) {
                showResult();
                return;
            }

            let questionText = "";
            if (difficulty === "easy") {
                // 使用 || 'N/A' 或 || '' 在 undefined/null 值時顯示空字串或 'N/A'
                questionText = `
                    <div class="mb-2">這是款來自<b><span class="math-inline">\{q\.Country \|\| 'N/A'\}</b\> 的 <b\></span>{q.Classification || 'N/A'}</b></div>
                    <div class="mb-2">酒的類型是：<b><span class="math-inline">\{q\.Wine\_type \|\| 'N/A'\}</b\>, <b\></span>{q.Sub_type || ''}</b></div>
                    <div class="mb-2">主要葡萄品種為：<b><span class="math-inline">\{q\.Grape\_1 \|\| 'N/A'\}</b\></div\>
