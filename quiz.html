<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è‘¡è„é…’æ³•å®šç”¢å€æ¨æ¸¬éŠæˆ²</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    </head>
<body class="bg-gray-100">
    <div id="quiz" class="max-w-xl mx-auto mt-4 p-6 bg-white rounded shadow">
        <div id="progress" class="text-sm text-gray-500 mb-2"></div>
        <div id="question-box" class="mb-4"></div>
        <div id="options-box" class="mb-4"></div>
        <div id="feedback" class="text-lg"></div>
    </div>

    <div class="max-w-xl mx-auto mt-6 flex justify-end">
        <button id="btn-back" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">
            é‡æ–°é¸æ“‡é¡Œåº«
        </button>
    </div>

    <audio id="aud-correct" src="sounds/correct.mp3" preload="auto"></audio>
    <audio id="aud-wrong" src="sounds/wrong.mp3" preload="auto"></audio>
    <audio id="aud-click" src="sounds/click.mp3" preload="auto"></audio>

    <script>
       const API_KEY = "AIzaSyCn4cdaBpY2Fz4SXUMtpMhAN84YvOQACcQ"; //

        // å®šç¾©ä¸åŒåœ‹å®¶è©¦ç®—è¡¨çš„ ID
        const SHEET_INDEX = {
            italy: { id: "1WLrMMYTPRjIxiWueFA1J3rfKzC34xbqver5tqCzP94s" },
            france: { id: "1-8sav2Dl1pi4EfnqNQhpMR0I-TjZhbaIUE6mrC1QbpU" },
            spain: { id: "1EeU1B3AF64S12XOIj9fLi-86_aMNcbmuEdKSBhsCpC4" },
            germany: { id: "1M0yjlT-bXXFhrV-snoGEPw6WhyMSwSEf4O6f7K_zo9o" }, // FIXED: Consistent ID with select.js
            usa: { id: "1ZsGBl0jHPhQu9nV3k5rJhJ4ZXkkrwSvA6qhY0RaTRxE" },
            hungary: { id: "1Rcf_mH4p1F05MhitSEkcjMaIU2mKmiXi77ifbOjfC14" },
            new_zealand: { id: "1O6TqxxB0YSitH9ySe3pncEx_Zl_kVtcJd2zslBDKw5Y" },
            austria: { id: "1qaxLc9-GMyHgPJCajU0Cs0-vrI4nRFsqn1Y3nvj_-m8" },
            portugal: { id: "18GCPNoDPXu9EcfPd0EmnpEJb0DsP7vQaoAdbGo9cMs4" },
            chile: { id: "1Dv2jeGsefsuCCyuu8uvMKkHd9NgNa7tV0Woo9FrBNEY" },
            south_africa: { id: "13K5yOvCJYZH6oiITdu5lyKH6a5az7octyuT3m7MzYEM" },
            argentina: { id: "1qE_4coepB5_vevCF4KLcZq7MMnrLtgU5foTN8e4nmLY" } // Corrected potential typo if different
        };

        // å…¨å±€è®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜æ‰€æœ‰é¡Œç›®ã€ç•¶å‰é¡Œç›®ç´¢å¼•ã€åˆ†æ•¸ã€é›£åº¦åŠé–‹å§‹æ™‚é–“
        let allQuestions = []; // å¾ Google Sheets è¼‰å…¥çš„æ‰€æœ‰é¡Œç›®
        let currentQuizQuestions = []; // ç•¶å‰æ¸¬é©—å›åˆè¦ä½¿ç”¨çš„é¡Œç›®ï¼ˆå›ºå®š10é¡Œï¼‰
        let allAppellations = []; // æ‰€æœ‰è¼‰å…¥çš„ Appellationï¼Œç”¨æ–¼ç”Ÿæˆé¸é …
        let currentQuestionIndex = 0;
        let score = 0;
        let difficulty = "easy";
        let startTime = 0;

        // éŠæˆ²è¨­å®šï¼šæ¯å›åˆçš„é¡Œç›®æ•¸é‡
        const QUIZ_LENGTH = 10;

        // å–å¾—ä¸»è¦æ¸¬é©—ç›¸é—œçš„ DOM å…ƒç´ å¼•ç”¨
        const quizContainer = document.getElementById("quiz");
        // These will be re-queried in startQuiz
        let questionBox = document.getElementById("question-box");
        let optionsBox = document.getElementById("options-box");
        let feedback = document.getElementById("feedback");
        let progressIndicator = document.getElementById("progress");

        /**
         * ç•°æ­¥å‡½æ•¸ï¼šè¼‰å…¥æ¸¬é©—é¡Œç›®è³‡æ–™
         * å¾ localStorage ç²å–ç”¨æˆ¶é¸æ“‡çš„å€åŸŸå’Œé›£åº¦ï¼Œ
         * ç„¶å¾Œä½¿ç”¨ Google Sheets API ç²å–è³‡æ–™ã€‚
         */
        async function loadQuizData() {
            quizContainer.innerHTML = '<p class="text-center text-gray-500">è¼‰å…¥é¡Œç›®ä¸­...</p>';

            const selected = JSON.parse(localStorage.getItem("selectedRegions") || "[]");
            difficulty = localStorage.getItem("difficulty") || "easy";

            if (selected.length === 0) {
                quizContainer.innerHTML = '<p class="text-center text-red-500">è«‹å…ˆåœ¨é¡Œåº«é¸æ“‡é é¢é¸æ“‡è¦ç·´ç¿’çš„ç”¢å€ã€‚</p>';
                return;
            }

            try {
                const fetches = selected.map(async key => {
                    const [countryKey, sheetName] = key.split("__");
                    const sheetId = SHEET_INDEX[countryKey]?.id; // ä½¿ç”¨ ?. é¿å…éŒ¯èª¤
                    if (!sheetId) {
                        console.warn(`SHEET_INDEX ä¸­æœªæ‰¾åˆ° ${countryKey} çš„ IDã€‚`);
                        return [];
                    }
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${API_KEY}`;
                    const res = await fetch(url);
                    if (!res.ok) {
                        throw new Error(`HTTP éŒ¯èª¤ï¼ç‹€æ…‹ç¢¼ï¼š${res.status}ï¼Œç¶²å€ï¼š${url}`);
                    }
                    const data = await res.json();
                    const rows = data.values;
                    if (!rows || rows.length < 2) {
                        console.warn(`æœªæ‰¾åˆ° ${key} çš„è³‡æ–™æˆ–åªæœ‰æ¨™é¡Œã€‚`);
                        return [];
                    }
                    const headers = rows[0];
                    return rows.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((h, i) => obj[h] = row[i] || "");
                        return obj;
                    });
                });

                const results = await Promise.all(fetches);
                allQuestions = results.flat().filter(q => q.Appellation); // éæ¿¾æ‰æ²’æœ‰ Appellation çš„é¡Œç›®

                // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„ Appellationï¼Œç”¨æ–¼ç”Ÿæˆé¸é …
                allAppellations = [...new Set(allQuestions.map(q => q.Appellation))];

                if (allQuestions.length === 0) {
                    quizContainer.innerHTML = '<p class="text-center text-red-500">æœªèƒ½è¼‰å…¥ä»»ä½•é¡Œç›®ï¼Œè«‹æª¢æŸ¥æ‰€é¸é¡Œåº«æ˜¯å¦æœ‰è³‡æ–™æˆ– Appellation æ¬„ä½ã€‚</p>';
                    return;
                }

                startQuiz(); // é–‹å§‹æ¸¬é©—

            } catch (error) {
                console.error("è¼‰å…¥æ¸¬é©—è³‡æ–™æ™‚å‡ºéŒ¯ï¼š", error);
                quizContainer.innerHTML = `<p class="text-center text-red-500">è¼‰å…¥é¡Œç›®å¤±æ•—ï¼š${error.message}ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚</p>`;
            }
        }

        /**
         * é–‹å§‹æ¸¬é©—
         * åˆå§‹åŒ–åˆ†æ•¸ã€é¡Œç›®ç´¢å¼•å’Œè¨ˆæ™‚å™¨ï¼Œä¸¦æ¸²æŸ“ç¬¬ä¸€é“é¡Œç›®ã€‚
         */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            startTime = Date.now();

            // å¾ allQuestions ä¸­éš¨æ©Ÿé¸å– QUIZ_LENGTH é¡Œä½œç‚ºæœ¬æ¬¡æ¸¬é©—çš„é¡Œç›®
            currentQuizQuestions = [...allQuestions]; // è¤‡è£½ä¸€ä»½ï¼Œä»¥å…å½±éŸ¿ allQuestions
            shuffle(currentQuizQuestions); // å…ˆæ‰“äº‚æ‰€æœ‰é¡Œç›®
            currentQuizQuestions = currentQuizQuestions.slice(0, QUIZ_LENGTH); // å–å‰ QUIZ_LENGTH é¡Œ

            if (currentQuizQuestions.length === 0) {
                quizContainer.innerHTML = '<p class="text-center text-red-500">æ²’æœ‰è¶³å¤ çš„é¡Œç›®å¯ä»¥é–‹å§‹æ¸¬é©—ï¼Œè«‹å˜—è©¦é¸æ“‡æ›´å¤šé¡Œåº«ã€‚</p>';
                return;
            }

            quizContainer.innerHTML = `
                <div id="progress" class="text-sm text-gray-500 mb-2"></div>
                <div id="question-box" class="mb-4"></div>
                <div id="options-box" class="mb-4"></div>
                <div id="feedback" class="text-lg"></div>
            `;
            // FIXED: Re-query DOM elements after innerHTML is updated
            questionBox = document.getElementById("question-box");
            optionsBox = document.getElementById("options-box");
            feedback = document.getElementById("feedback");
            progressIndicator = document.getElementById("progress");

            renderQuestion();
        }

        /**
         * æ¸²æŸ“é¡Œç›®åˆ°é é¢
         * æ ¹æ“šç•¶å‰é¡Œç›®ç´¢å¼•å’Œé›£åº¦é¡¯ç¤ºé¡Œç›®å…§å®¹å’Œé¸é …ã€‚
         */
        function renderQuestion() {
            // å¾ currentQuizQuestions ä¸­ç²å–ç•¶å‰é¡Œç›®
            const q = currentQuizQuestions[currentQuestionIndex];
            if (!q) {
                showResult();
                return;
            }

            let questionText = "";
            if (difficulty === "easy") {
                questionText = `
                    <div class="mb-2">é€™æ˜¯æ¬¾ä¾†è‡ª<b>${q.Country}</b> çš„ <b>${q.Classification}</b></div>
                    <div class="mb-2">é…’çš„é¡å‹æ˜¯ï¼š<b>${q.Wine_type}</b>, <b>${q.Sub_type}</b></div>
                    <div class="mb-2">ä¸»è¦è‘¡è„å“ç¨®ç‚ºï¼š<b>${q.Grape_1}</b></div>
                    <div class="mb-2">æ˜¯å¦æ··é‡€ï¼š<b>${q.Is_blend}</b></div>
                    <div class="mb-2">æ¬¡è¦è‘¡è„å“ç¨®ç‚ºï¼š<b>${q.Grape_2}</b></div>
                    <div class="mb-2">æ¬¡ç”¢å€ï¼š<b>${q.Sub_region}</b></div>
                    <div class="my-4 font-semibold">è«‹å•é€™æ˜¯å“ªå€‹æ³•å®šç”¢å€ï¼Ÿ</div>
                `;
            } else {
                questionText = `
                    é€™æ˜¯æ¬¾ã€${q.Wine_type}ã€‘ï¼Œ<br/>
                    ä¸»è¦ä½¿ç”¨ã€${q.Grape_1}ã€‘é‡€è£½ï¼Œ<br/>
                    è«‹å•é€™æ˜¯å“ªå€‹æ³•å®šç”¢å€?
                `;
            }
            questionBox.innerHTML = questionText;

            progressIndicator.textContent = `ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${currentQuizQuestions.length} é¡Œ`;

            // ç”Ÿæˆé¸é …ï¼šå¾æ‰€æœ‰è¼‰å…¥çš„ Appellation ä¸­éš¨æ©ŸæŒ‘é¸ 3 å€‹ä¸åŒçš„éŒ¯èª¤é¸é …
            const correctAppellation = q.Appellation;
            const options = [correctAppellation];
            const availableAppellationsForOptions = allAppellations.filter(app => app !== correctAppellation); // æ’é™¤æ­£ç¢ºç­”æ¡ˆ

            shuffle(availableAppellationsForOptions); // æ‰“äº‚å¯ç”¨é¸é …

            // å¾æ‰“äº‚å¾Œçš„å¯ç”¨é¸é …ä¸­é¸å–ï¼Œç¢ºä¿é¸é …æ•¸é‡ç‚º4å€‹
            for (let i = 0; options.length < 4 && i < availableAppellationsForOptions.length; i++) {
                options.push(availableAppellationsForOptions[i]);
            }

            // å¦‚æœå¯ç”¨é¸é …ä¸è¶³ä»¥å¡«å……4å€‹é¸é …ï¼Œå‰‡å¯èƒ½æœ‰é‡è¤‡ï¼Œä½†é€™æ»¿è¶³ã€Œå¯ä»¥é‡è¤‡ä½œç‚ºç­”æ¡ˆæŒ‘é¸ã€çš„è¦æ±‚
            // ä¸”ã€Œå¾å‹¾é¸çš„Regionè£¡æŒ‘é¸ã€çš„é¸é …ä¾†æºæ˜¯ allAppellationsï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰å·²è¼‰å…¥ç”¢å€çš„ Appellation
            // ç¢ºä¿é¸é …è‡³å°‘æœ‰4å€‹ï¼Œå¦‚æœallAppellationsæ•¸é‡ä¸è¶³ï¼Œæœƒé‡è¤‡åŠ å…¥ã€‚
            while (options.length < 4) {
                const randomApp = allAppellations[Math.floor(Math.random() * allAppellations.length)];
                if (!options.includes(randomApp) || allAppellations.length < 4) { // å¦‚æœAppellationå°‘æ–¼4å€‹ï¼Œå…è¨±é‡è¤‡
                    options.push(randomApp);
                }
            }


            shuffle(options); // å†æ¬¡æ‰“äº‚æœ€çµ‚çš„é¸é …é †åº

            optionsBox.innerHTML = "";
            options.forEach(option => {
                const btn = document.createElement("button");
                btn.textContent = option;
                btn.className = "block w-full text-left px-4 py-2 mb-2 bg-white border rounded hover:bg-blue-100";
                btn.onclick = () => checkAnswer(option, correctAppellation);
                optionsBox.appendChild(btn);
            });
            feedback.textContent = "";
        }

        /**
         * æª¢æŸ¥ç”¨æˆ¶é¸æ“‡çš„ç­”æ¡ˆ
         * æ ¹æ“šé¸æ“‡çš„ç­”æ¡ˆæ˜¯å¦æ­£ç¢ºæ›´æ–°åˆ†æ•¸ä¸¦é¡¯ç¤ºå›é¥‹è¨Šæ¯ã€‚
         */
        function checkAnswer(selected, correct) {
            Array.from(optionsBox.children).forEach(button => {
                button.disabled = true;
                if (button.textContent === correct) {
                    button.classList.add("border-green-500", "bg-green-100", "font-bold");
                } else if (button.textContent === selected) {
                    button.classList.add("border-red-500", "bg-red-100");
                }
            });

            if (selected === correct) {
                score++;
                feedback.textContent = "ç­”å°äº†ï¼";
                feedback.className = "text-green-600 mb-4 font-bold";
                playSound("correct");
            } else {
                feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`;
                feedback.className = "text-red-600 mb-4 font-bold";
                playSound("wrong");
            }

            currentQuestionIndex++;
            // æª¢æŸ¥æ˜¯å¦é”åˆ°QUIZ_LENGTHçš„é¡Œç›®æ•¸é‡ï¼Œè€Œä¸æ˜¯allQuestions.length
            if (currentQuestionIndex < QUIZ_LENGTH) {
                setTimeout(() => {
                    renderQuestion();
                }, 1500);
            } else {
                setTimeout(showResult, 1500);
            }
        }

        /**
         * é¡¯ç¤ºæ¸¬é©—çµæœ
         * è¨ˆç®—ç¸½è€—æ™‚ï¼Œé¡¯ç¤ºå¾—åˆ†ï¼Œä¸¦æä¾›å„²å­˜æˆç¸¾åˆ°æ’è¡Œæ¦œçš„åŠŸèƒ½ã€‚
         */
        function showResult() {
            const totalTime = Math.round((Date.now() - startTime) / 1000);
            // ç¸½é¡Œç›®æ•¸ç¾åœ¨æ˜¯ QUIZ_LENGTH
            const totalQ = QUIZ_LENGTH;

            quizContainer.innerHTML = `
                <div class="text-xl font-bold mb-4">ğŸ‰ æ¸¬é©—å®Œæˆï¼</div>
                <div class="mb-2">å¾—åˆ†ï¼š${score} / ${totalQ}</div>
                <div class="mb-4">è€—æ™‚ï¼š${totalTime} ç§’ã€€ï½œã€€é›£åº¦ï¼š${difficulty}</div>
                <input id="player-name" type="text" placeholder="è¼¸å…¥æš±ç¨±å„²å­˜æˆç¸¾"
                        class="border px-3 py-1 rounded w-full mb-4" />
                <button id="save-btn" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mb-6">å„²å­˜åˆ°æ’è¡Œæ¦œ</button>
                <h3 class="font-semibold mb-2">ğŸ† æ’è¡Œæ¦œï¼ˆå‰ 10 åï¼‰</h3>
                <ol id="board" class="list-decimal list-inside mb-6"></ol>
                <button onclick="toSelectPage()" class="w-full py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    é‡æ–°é¸æ“‡é¡Œåº«
                </button>
            `;

            document.getElementById("save-btn").onclick = () =>
                saveLeaderboard(totalQ, totalTime);

            renderBoard();
        }

        /**
         * å„²å­˜æˆç¸¾åˆ°æœ¬åœ°å„²å­˜çš„æ’è¡Œæ¦œä¸­
         */
        function saveLeaderboard(totalQ, totalTime) {
            const name = document.getElementById("player-name").value.trim() || "ç©å®¶";
            const record = {
                name,
                score,
                totalQ,
                time: totalTime,
                difficulty,
                date: new Date().toLocaleString()
            };

            const board = JSON.parse(localStorage.getItem("leaderboard") || "[]");
            board.push(record);
            board.sort((a, b) => b.score - a.score || a.time - b.time);
            localStorage.setItem("leaderboard", JSON.stringify(board.slice(0, 10)));
            renderBoard();
            document.getElementById("player-name").value = "";
        }

        /**
         * æ¸²æŸ“æ’è¡Œæ¦œåˆ°é é¢
         */
        function renderBoard() {
            const list = document.getElementById("board");
            if (!list) return;
            const board = JSON.parse(localStorage.getItem("leaderboard") || "[]");
            list.innerHTML = board
                .map(
                    (r, i) =>
                        `<li>${r.name} - ${r.score}/${r.totalQ} åˆ† - ${r.time}s - ${r.difficulty.toUpperCase()} - ${r.date}</li>`
                )
                .join("");
        }

        /**
         * æ´—ç‰Œæ¼”ç®—æ³• (Fisher-Yates shuffle)
         * éš¨æ©Ÿæ‰“äº‚é™£åˆ—é †åºã€‚
         */
        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        /**
         * æ’­æ”¾éŸ³æ•ˆ
         */
        function playSound(type) {
            const aud = document.getElementById(`aud-${type}`);
            if (aud) {
                aud.currentTime = 0;
                aud.play().catch(e => console.warn(`éŸ³æ•ˆæ’­æ”¾å¤±æ•— (${type}):`, e));
            }
        }

        /**
         * è·³è½‰åˆ°é¸æ“‡é¡Œåº«é é¢
         */
        function toSelectPage() {
            location.href = "select.html";
        }

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById("btn-back").onclick = toSelectPage;
        window.onload = loadQuizData;
    </script>
</body>
</html>
