<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‘¡è„é…’é¡Œåº«ä½œç­”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <main class="max-w-3xl w-full bg-white p-6 rounded-xl shadow-lg">
    <header>
      <h1 class="text-2xl font-bold mb-4 flex items-center gap-2" tabindex="0">
        <span role="img" aria-label="å•ç­”">ğŸ·</span>
        è‘¡è„é…’é¡Œåº«ä½œç­”
      </h1>
    </header>
    <div id="debug-info" class="text-sm text-red-600 mb-4"></div>
    <section id="quiz-content" aria-label="é¡Œç›®å€"></section>
    <noscript>
      <p class="text-red-600 mt-4">è«‹å•Ÿç”¨ JavaScript ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</p>
    </noscript>
  </main>
  <script>
    // è¨­å®šè³‡æ–™
    const SHEET_INDEX = {
      italy: {
        id: "1dFJJuIBfIF5mnzAAG2poQKMKQKTVhEUDHuS1YX9RilA",
        label: "ç¾©å¤§åˆ©",
        flag: "ğŸ‡®ğŸ‡¹"
      },
      france: {
        id: "1-8sav2Dl1pi4EfnqNQhpMR0I-TjZhbaIUE6mrC1QbpU",
        label: "æ³•åœ‹",
        flag: "ğŸ‡«ğŸ‡·"
      },
      spain: {
        id: "1Zngq4LPi1E7edjopwvr7MS2dCRN1GW2rKuOetHPuhnY",
        label: "è¥¿ç­ç‰™",
        flag: "ğŸ‡ªğŸ‡¸"
      }
    };
    const API_KEY = "AIzaSyCn4cdaBpY2Fz4SXUMtpMhAN84YvOQACcQ";
    const debug = (msg) => {
      document.getElementById('debug-info').innerText = msg;
      console.warn(msg);
    };

    // å–å¾—ä½¿ç”¨è€…é¸æ“‡
    let selected = [];
    try {
      selected = JSON.parse(localStorage.getItem('selectedRegions')) || [];
    } catch (e) {
      debug("åµéŒ¯ï¼šç„¡æ³•å–å¾—é¸æ“‡è³‡è¨Šï¼Œè«‹å›åˆ°ä¸Šä¸€é é‡æ–°é¸æ“‡ã€‚");
    }

    if (!selected.length) {
      debug("åµéŒ¯ï¼šæ²’æœ‰é¸æ“‡ä»»ä½•ç”¢å€ï¼Œè«‹å›åˆ°ä¸Šä¸€é å‹¾é¸ã€‚");
    }

    // è§£æé¸æ“‡
    function parseSelection(str) {
      // æ ¼å¼ï¼šitaly__ç¾©å¤§åˆ©åŒ—éƒ¨
      const [country, sheet] = str.split('__');
      return {country, sheet};
    }

    // å–å¾— Google Sheet é¡Œåº«
    async function fetchSheetData(sheetId, sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          debug(`åµéŒ¯ï¼šAPI è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ ${res.status}ã€‚è«‹æª¢æŸ¥ Google Sheet æ¬Šé™èˆ‡ API Keyã€‚`);
          return null;
        }
        const data = await res.json();
        return data.values;
      } catch (e) {
        debug("åµéŒ¯ï¼šè³‡æ–™æŠ“å–å¤±æ•—ï¼Œè©³ç´°ï¼š" + e.message);
        return null;
      }
    }

    // é¡¯ç¤ºé¡Œåº«è³‡æ–™
    async function showQuiz() {
      const container = document.getElementById('quiz-content');
      container.innerHTML = '';
      if (!selected.length) {
        container.innerHTML = '<p class="text-red-600">æ²’æœ‰é¸æ“‡ç”¢å€ï¼Œè«‹å›åˆ°ä¸Šä¸€é ã€‚</p>';
        return;
      }
      for (const region of selected) {
        const {country, sheet} = parseSelection(region);
        const sheetId = SHEET_INDEX[country]?.id;
        const countryLabel = SHEET_INDEX[country]?.label || country;
        const flag = SHEET_INDEX[country]?.flag || '';
        if (!sheetId) {
          debug(`åµéŒ¯ï¼šæ‰¾ä¸åˆ° ${country} çš„ Sheet ID`);
          continue;
        }
        const values = await fetchSheetData(sheetId, sheet);
        if (!values) {
          container.innerHTML += `<div class="mb-6"><h2 class="font-bold">${flag} ${countryLabel} - ${sheet}</h2><div class="text-red-600">è¼‰å…¥é¡Œåº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google Sheetã€‚</div></div>`;
          continue;
        }
        // ç°¡å–®é¡¯ç¤ºé¡Œåº«å…§å®¹
        container.innerHTML += `
          <div class="mb-6">
            <h2 class="font-bold">${flag} ${countryLabel} - ${sheet}</h2>
            <table class="w-full border mt-2 text-sm">
              <tbody>
                ${values.map(row => `<tr>${row.map(cell => `<td class="border px-2 py-1">${cell}</td>`).join('')}</tr>`).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    }

    showQuiz();
  </script>
</body>
</html>
